<script type="text/javascript">
    RED.nodes.registerType('zigbee-shepherd', {
        category: 'config',
        credentials: {
            panId: {
                type: 'text',
                value: 'ffff',
                validate(v) {
                    if (!/[0-9a-fA-F]{4}/.test(v)) {
                        return false;
                    }

                    v = parseInt(v, 16);
                    return v === 65535 || (v >= 0 && v <= 16383);
                }
            },
            extPanId: {
                type: 'text',
                value: 'dddddddddddddddd',
                validate(v) {
                    return /^[0-9a-fA-F]{16}$/.test(v);
                }
            },
            precfgkey: {
                type: 'text',
                value: '01030507090B0D0F00020406080A0C0D',
                validate(v) {
                    return /^[0-9a-fA-F]{32}$/.test(v);
                }
            }
        },
        defaults: {
            name: {value: 'zigbee herdsman', require: true},
            path: {value: '/dev/ttyACM0', required: true},
            baudRate: {value: 115200, required: true},
            rtscts: {value: true},
            channelList: {value: [11]},
            led: {value: 'disabled'},
            adapter: {value: 'zstack'}
        },
        label() {
            return this.name || 'zigbee herdsman';
        },
        paletteLabel: 'herdsman',
        oneditprepare() {
            console.log('oneditprepare creds', this.credentials);

            const {id} = this;
            let groups;
            const clusters = {};

            $.getJSON('zigbee-shepherd/definitions', data => {
                Object.keys(data.Cluster).forEach(cluster => {
                    clusters[data.Cluster[cluster].ID] = cluster;
                });
            });

            const tabs = RED.tabs.create({
                id: 'node-config-zigbee-shepherd-tabs',
                onchange(tab) {
                    $('#node-config-zigbee-shepherd-tabs-content').children().hide();
                    $('#' + tab.id).show();
                }
            });
            tabs.addTab({
                id: 'zigbee-shepherd-tab-config',
                label: 'Config'
            });
            tabs.addTab({
                id: 'zigbee-shepherd-tab-devices',
                label: 'Devices'
            });
            tabs.addTab({
                id: 'zigbee-shepherd-tab-reporting',
                label: 'DevConfig'
            });
            tabs.addTab({
                id: 'zigbee-shepherd-tab-groups',
                label: 'Groups'
            });
            tabs.addTab({
                id: 'zigbee-shepherd-tab-binds',
                label: 'Binds'
            });

            $('#error-dialog').dialog({
                id: 'error-dialog-ui',
                autoOpen: false,
                modal: true,
                closeOnEscape: true,
                width: 480,
                buttons: [
                    {
                        text: 'Dismiss',
                        click() {
                            $(this).dialog('close');
                        }
                    }
                ]
            });

            $('#device-details-dialog').dialog({
                id: 'device-details-ui',
                autoOpen: false,
                modal: true,
                closeOnEscape: true,
                width: 480,
                buttons: [
                    {
                        text: 'Close',
                        click() {
                            $(this).dialog('close');
                        }
                    }
                ]
            });

            function showError(msg) {
                $('#error-message').html(msg);
                $('#error-dialog').dialog('open');
            }

            function getStatus() {
                $.get('zigbee-shepherd/status?id=' + id, status => {
                    $('#status').html(status);
                    switch (status) {
                        case 'connected':
                            break;
                        case 'join permitted':
                            break;
                        default:
                    }
                });
            }

            this.statusInterval = setInterval(getStatus, 1000);

            $('#rtscts').val(String(Boolean(this.rtscts)));
            $('#rtscts').trigger('change');

            if (!this.credentials.panId) {
                $('#node-config-input-panId').val('ffff');
            }

            if (!this.credentials.precfgkey) {
                $('#node-config-input-precfgkey').val('01030507090B0D0F00020406080A0C0D');
            }

            if (!this.credentials.extPanId) {
                $('#node-config-input-extPanId').val('dddddddddddddddd');
            }

            this.channelList.forEach(channel => {
                if (channel) {
                    $('#channel-' + channel).prop('checked', true);
                }
            });

            // Tab Devices
            let devices = [];

            const refreshDevices = () => {
                if (this.refreshPending) {
                    return;
                }

                this.refreshPending = true;

                $.getJSON('zigbee-shepherd/devices?id=' + id, data => {
                    this.devices = data;
                    devices = data;
                    const known = [];
                    const deviceSelect = [];
                    data.sort((a, b) => {
                        if (a.meta.name === 'Coordinator') {
                            return -1;
                        }

                        if (b.meta.name === 'Coordinator') {
                            return 1;
                        }

                        return String(a.meta.name).localeCompare(b.meta.name);
                    }).forEach(device => {
                        deviceSelect.push(`<option value="${device.ieeeAddr}">${device.meta.name} ${device.ieeeAddr}</option>`);
                        if ($('.device-select').find('option[value="' + device.ieeeAddr + '"]').length === 0) {
                            const desc = (device.meta.name || '') + ' ' + device.ieeeAddr;
                            $('.device-select').append(`<option value="${device.ieeeAddr}">${desc}</option>`);
                        }

                        known.push(device.ieeeAddr);
                        if ($('.device-address.incomplete[data-addr="' + device.ieeeAddr + '"]')) {
                            $('.device-address.incomplete[data-addr="' + device.ieeeAddr + '"]').parent().parent().remove();
                        }

                        if ($('ol#devices .device-name[data-addr="' + device.ieeeAddr + '"]').length === 0) {
                            $('ol#devices').editableList('addItem', device);
                        }

                        if ($('ol#reporting .device-report[data-addr="' + device.ieeeAddr + '"]').length === 0) {
                            if (device.type !== 'Coordinator') {
                                $('ol#reporting').editableList('addItem', device);
                            }
                        }

                        let index = 0;
                        device.endpoints.filter(e => e.binds.length > 0).forEach(e => {
                            e.binds.forEach(b => {
                                let data;
                                if (b.target.groupID) {
                                    const tGroup = groups.find(g => g.groupID === b.target.groupID);
                                    data = {
                                        index,
                                        ieeeAddr: device.ieeeAddr,
                                        name: device.meta.name,
                                        endpoint: e.ID,
                                        cluster: b.cluster.name,
                                        targetDevice: tGroup.groupID,
                                        targetName: tGroup.meta.name,
                                        targetEndpoint: '',
                                        type: 'group'
                                    };
                                } else {
                                    const tDevice = devices.find(d => d.ieeeAddr === b.target.deviceIeeeAddress);
                                    data = {
                                        index,
                                        ieeeAddr: device.ieeeAddr,
                                        name: device.meta.name,
                                        endpoint: e.ID,
                                        cluster: b.cluster.name,
                                        targetDevice: tDevice.ieeeAddr,
                                        targetName: tDevice.meta.name,
                                        targetEndpoint: b.target.ID,
                                        type: 'endpoint'
                                    };
                                }

                                if ($('ol#binds .bind-address[data-addr="' + device.ieeeAddr + '"][data-index="' + index + '"]').length === 0) {
                                    if (data.targetName !== 'Coordinator' || $('#show-coord-binds').is(':checked')) {
                                        $('ol#binds').editableList('addItem', data);
                                    }
                                }

                                index += 1;
                            });
                        });
                    });
                    $('#show-coord-binds').change(() => {
                        $('ol#binds').editableList('empty');
                        refreshDevices();
                    });
                    $('ol#devices li .device-name').each(function () {
                        const addr = $(this).data('addr');
                        if (!known.includes(addr)) {
                            $(this).parent().parent().remove();
                        }
                    });
                    $('ol#reporting li .device-report').each(function () {
                        const addr = $(this).data('addr');
                        if (!known.includes(addr)) {
                            $(this).parent().parent().remove();
                        }
                    });
                    $('#add-bind-device').html(deviceSelect);
                    $('#add-bind-targetDevice').html(deviceSelect);

                    autocompleteMemberEndpoint();

                    this.refreshPending = false;
                });
            };

            $('ol#binds').editableList({
                addItem(row, index, data) {
                    $(row).html(`<span class="bind-title">Source:</span>
                        <span data-addr="${data.ieeeAddr}" data-index="${data.index}" class="bind-address">${data.ieeeAddr}</span>
                        <span class="bind-endpoint">${data.endpoint}</span>
                        <span class="bind-cluster">${data.cluster}</span>
                        <span class="bind-name">${data.name}</span>
                        <br>
                        <span class="bind-title">Target:</span>
                        <span class="bind-targetIeeeAddr">${data.type === 'group' ? 'Group ' : ''}${data.targetDevice}</span>
                        <span class="bind-targetEndpoint">${data.targetEndpoint}</span>
                        <span class="bind-cluster"></span>
                        <span class="bind-targetName">${data.targetName}</span>
                        <a href="#" data-type="${data.type}" data-device="${data.ieeeAddr}" data-endpoint="${data.endpoint}" data-cluster="${data.cluster}" data-target-device="${data.targetDevice}" data-target-endpoint="${data.targetEndpoint}" data-index="${data.index}" class="bind-remove red-ui-editableList-item-remove editor-button editor-button-small"><i class="fa fa-remove"></i></a>
                    `);
                },
                addButton: false,
                removable: false
            });

            $('ol#reporting').editableList({
                height: '100%',
                header: $('<div>').append($.parseHTML(`<span class="device-address"></span>
                    <span class="device-model"></span>
                    <span class="checkbox-reporting">Report</span>
                    <span class="checkbox-configure">Config</span>
                    </span><span class="checkbox-ping">Ping</span>
                    <span class="member-name"></span>`)),
                addItem(row, index, device) {
                    const html = `<span data-addr="${device.ieeeAddr}" class="device-address">${device.ieeeAddr}<br>${device.type}</span>
                        <span class="device-model">${device.manufacturerName}<br>${device.modelID}</span><span class="checkbox-reporting">
                        <input data-addr="${device.ieeeAddr}" class="device-report" type="checkbox" ${device.meta.shouldReport ? 'checked' : ''} ${device.meta.isReportable ? '' : 'disabled'}>
                        </span><span class="checkbox-configure">
                        <input data-addr="${device.ieeeAddr}" class="device-configure" type="checkbox" ${device.meta.shouldConfigure ? 'checked' : ''} ${device.meta.isConfigurable ? '' : 'disabled'}>
                        </span><span class="checkbox-ping">
                        <input data-addr="${device.ieeeAddr}" class="device-ping" type="checkbox" ${device.meta.shouldPing ? 'checked' : ''} ${device.meta.isPingable ? '' : 'disabled'}>
                        </span><span class="member-name">${device.meta.name}</span>`;
                    $(row).html(html);
                },
                addButton: false,
                removable: false
            });

            $('ol#devices').editableList({
                addItem(row, index, data) {
                    $(row).html(`<span data-addr="${data.ieeeAddr}" class="device-address ${data.interviewCompleted ? '' : 'incomplete'}">${data.ieeeAddr}<br>${data.type}</span>
                        <span class="device-model">${data.meta.isCoordinator ? data.meta.type : data.manufacturerName}<br>${data.meta.isCoordinator ? data.meta.version + ' ' + data.meta.revision : data.modelID}</span>
                        <input ${data.meta.isCoordinator ? 'disabled' : ''} style="margin-top: -13px" class="device-name" data-addr="${data.ieeeAddr}" value="${data.meta.name}" type="text">
                        <a href="#" data-addr="${data.ieeeAddr}" class="device-details editor-button editor-button-small"><i class="fa fa-info"></i></a>
                        <a href="#" data-addr="${data.ieeeAddr}" class="${data.meta.isCoordinator ? 'disabled' : ''} device-remove red-ui-editableList-item-remove editor-button editor-button-small"><i class="fa fa-remove"></i></a>
                    `);
                },
                addButton: false,
                removable: false
            });

            $('ol#devices').on('click', '.device-remove', function () {
                $(this).addClass('disabled');
                $.get('zigbee-shepherd/remove?id=' + id + '&ieeeAddr=' + $(this).data('addr'), () => {
                    refreshDevices();
                });
            });

            $('ol#devices').on('click', '.device-details', function () {
                const dev = devices.find(d => d.ieeeAddr === $(this).data('addr'));
                $('#device-details').html(JSON.stringify(dev, null, '    '));
                $('#device-details-dialog').dialog('option', 'title', `${dev.ieeeAddr} ${dev.meta.name}`);
                $('#device-details-dialog').dialog('open');
            });

            $('#soft-reset').click(() => {
                $.getJSON('zigbee-shepherd/soft-reset?id=' + id, () => {});
            });

            $('#touchlink-reset').click(() => {
                $.getJSON('zigbee-shepherd/touchlink-reset?id=' + id, () => {});
            });

            $('#join-permit').click(() => {
                $.getJSON('zigbee-shepherd/join?id=' + id + '&permit=true', () => {});
                clearInterval(this.refreshInterval);
                this.refreshInterval = setInterval(() => {
                    refreshDevices();
                }, 1000);
            });

            $('#join-stop').click(() => {
                $.getJSON('zigbee-shepherd/join?id=' + id + '&permit=false');
                clearInterval(this.refreshInterval);
            });

            $('#network-map').appendTo(document.body);

            let stopMap = false;

            $('#show-network-map').click(() => {
                $('#network-map').show();
                stopMap = false;
                networkMap(this.id);
            });

            $('#hide-network-map').click(() => {
                if (networkMap && networkMap.destroy) {
                    networkMap.destroy();
                }

                $('#network-map').hide();
                stopMap = true;
            });

            // Groups

            $('ol#groups').editableList({
                addItem(row, index, data) {
                    $(row).html(`<div class="group-row ${data.selected ? 'selected' : ''}" data-groupid="${data.groupID}" data-name="${data.name}">
                            <span class="group-id">${data.groupID}</span><input class="group-name" data-groupid="${data.groupID}" type="text" value="${data.name}">
                            <a href="#" data-groupid="${data.groupID}" style="right: 5px" class="${data.members.length > 0 ? 'disabled' : ''} group-remove red-ui-editableList-item-remove editor-button editor-button-small"><i class="fa fa-remove"></i></a>
                        </div>
                    `);
                },
                addButton: false,
                removable: false
            });

            $('ol#groups').on('click', '.group-remove', function () {
                const groupID = parseInt($(this).data('groupid'), 10);
                $(this).addClass('disabled');
                $.ajax({
                    type: 'POST',
                    url: 'zigbee-shepherd/removeGroup?id=' + id,
                    contentType: 'application/json',
                    data: JSON.stringify({groupID}),
                    success: () => {
                        $('#selected-group-id').val('');
                        refreshGroups();
                    },
                    error: xhr => {
                        showError(xhr.responseText);
                    }
                });
            });

            $('ol#members').editableList({
                addItem(row, index, data) {
                    const {device, endpoint} = data;
                    $(row).html(`<span data-addr="${device.ieeeAddr}" class="device-address">${device.ieeeAddr}<br>${device.type}</span>
                        <span class="device-model">${device.manufacturerName}<br>${device.modelID}</span>
                        <span class="member-endpoint">${endpoint.ID}</span>
                        <span class="member-name">${device.meta.name}</span>
                        <a href="#" data-epid="${endpoint.ID}" data-addr="${device.ieeeAddr}" class="member-remove red-ui-editableList-item-remove editor-button editor-button-small"><i class="fa fa-remove"></i></a>
                    `);
                },
                addButton: false,
                removable: false
            });

            $('ol#members').on('click', '.member-remove', function () {
                $(this).addClass('disabled');
                const selectedGroup = parseInt($('#selected-group-id').val(), 10);
                $.ajax({
                    type: 'POST',
                    url: 'zigbee-shepherd/removeFromGroup?id=' + id,
                    contentType: 'application/json',
                    data: JSON.stringify({groupID: selectedGroup, ieeeAddr: $(this).data('addr'), epID: parseInt($(this).data('epid'), 10)}),
                    success: () => {
                        $(this).parent().parent().remove();
                        refreshGroups();
                    },
                    error: xhr => {
                        $(this).removeClass('disabled');
                        showError(xhr.responseText);
                    }
                });
            });

            function refreshMembers() {
                $('ol#members').editableList('empty');
                $('#selected-group').html('');
                const selectedGroup = parseInt($('#selected-group-id').val(), 10);
                const group = groups.find(group => group.groupID === selectedGroup);
                if (!group) {
                    return;
                }

                const deviceList = [];
                group.members.forEach(member => {
                    const device = devices.find(device => device.ieeeAddr === member.deviceIeeeAddr);
                    deviceList.push({device, endpoint: {ID: member.ID}});
                    $('ol#members').editableList('empty');
                    $('ol#members').editableList('addItems', deviceList);
                });
                $('#selected-group').html('Members of Group ' + group.groupID + '  ' + group.meta.name);
            }

            $('ol#groups').on('click', '.group-row', function () {
                const groupID = parseInt($(this).data('groupid'), 10);
                $('#add-member').removeClass('disabled');
                $('ol#groups .group-row').removeClass('selected');
                $(this).addClass('selected');
                $('#selected-group-id').val(groupID);

                refreshMembers();
            });

            function refreshGroups() {
                $.getJSON('zigbee-shepherd/groups?id=' + id, data => {
                    groups = data;
                    this.groups = data;
                    $('#add-bind-group').html('');
                    $('ol#groups').editableList('empty');
                    const selectedGroup = parseInt($('#selected-group-id').val(), 10);
                    groups.forEach(group => {
                        $('#add-bind-group').append(`<option value="${group.groupID}">${group.groupID} ${group.meta.name}</option>`);
                        $('ol#groups').editableList('addItem', {groupID: group.groupID, name: group.meta.name, members: group.members, selected: selectedGroup === group.groupID});
                    });
                    refreshMembers();
                });
            }

            refreshGroups.call(this);
            refreshDevices(true);

            function autocompleteCluster() {
                const ieeeAddr = $('#add-bind-device').val();
                const device = devices.filter(d => d.ieeeAddr === ieeeAddr)[0];
                if (!device) {
                    $('#add-bind-cluster').html('');
                    return;
                }

                const epId = parseInt($('#add-bind-endpoint').val(), 10);
                const endpoint = device.endpoints.filter(e => e.ID === epId)[0];
                if (!endpoint) {
                    $('#add-bind-cluster').html('');
                    return;
                }

                $('#add-bind-cluster').html([...endpoint.inputClusters, ...endpoint.outputClusters].map(cid => `<option>${clusters[cid]}</option>`));
            }

            function autocompleteEndpoint() {
                const ieeeAddr = $('#add-bind-device').val();
                const device = devices.filter(d => d.ieeeAddr === ieeeAddr)[0];
                if (!device) {
                    $('#add-bind-endpoint').html('');
                    return;
                }

                $('#add-bind-endpoint').html(device.endpoints.map(e => `<option value="${e.ID}">${e.ID}</option>`));
                autocompleteCluster();
            }

            $('#add-member-select').change(autocompleteMemberEndpoint);

            function autocompleteMemberEndpoint() {
                const ieeeAddr = $('#add-member-select').val();
                const device = devices.filter(d => d.ieeeAddr === ieeeAddr)[0];
                if (!device) {
                    $('#add-member-endpoint-select').html('');
                    return;
                }

                $('#add-member-endpoint-select').html(device.endpoints.map(e => `<option value="${e.ID}">${e.ID}</option>`));
            }

            function autocompleteTargetEndpoint() {
                const ieeeAddr = $('#add-bind-targetDevice').val();
                const device = devices.filter(d => d.ieeeAddr === ieeeAddr)[0];
                if (!device) {
                    $('#add-bind-targetEndpoint').html('');
                    return;
                }

                $('#add-bind-targetEndpoint').html(device.endpoints.map(e => `<option value="${e.ID}">${e.ID}</option>`));
            }

            $('#add-bind-device').change(autocompleteEndpoint);
            $('#add-bind-targetDevice').change(autocompleteTargetEndpoint);
            $('#add-bind-endpoint').change(autocompleteCluster);

            $('#add-member-dialog').dialog({
                autoOpen: false,
                modal: true,
                closeOnEscape: true,
                width: 600,
                buttons: [
                    {
                        text: 'Add Member',
                        id: 'add-member-to-group',
                        click() {
                            const ieeeAddr = $('#add-member-select').val();
                            const endpoint = parseInt($('#add-member-endpoint-select').val(), 10);
                            const selectedGroup = parseInt($('#selected-group-id').val(), 10);
                            $.ajax({
                                type: 'POST',
                                url: 'zigbee-shepherd/addGroupMember?id=' + id,
                                contentType: 'application/json',
                                data: JSON.stringify({groupID: selectedGroup, ieeeAddr, endpoint}),
                                success: () => {
                                    refreshGroups();
                                    refreshMembers();
                                    $(this).dialog('close');
                                },
                                error: xhr => {
                                    showError(xhr.responseText);
                                }
                            });
                        }
                    },
                    {
                        text: 'Cancel',
                        click() {
                            $(this).dialog('close');
                        }
                    }
                ]
            });
            $('#add-member').click(() => {
                $('#add-member-dialog').dialog('open');
            });

            $('#add-group-dialog').dialog({
                autoOpen: false,
                modal: true,
                closeOnEscape: true,
                width: 400,
                buttons: [
                    {
                        text: 'Add Group',
                        id: 'add-group',
                        click() {
                            const groupID = parseInt($('#add-group-id').val(), 10);
                            const name = $('#add-group-name').val();

                            $.ajax({
                                type: 'POST',
                                url: 'zigbee-shepherd/createGroup?id=' + id,
                                contentType: 'application/json',
                                data: JSON.stringify({groupID, name}),
                                success: () => {
                                    $(this).dialog('close');
                                    refreshGroups();
                                },
                                error: xhr => {
                                    showError(xhr.responseText);
                                }
                            });
                        }
                    }, {
                        text: 'Cancel',
                        click() {
                            $(this).dialog('close');
                        }
                    }
                ]
            });
            $('#add-group').click(() => {
                $('#add-group-dialog').dialog('open');
            });

            $('ol#binds').on('click', '.bind-remove', function () {
                $(this).addClass('disabled');
                $.ajax({
                    type: 'POST',
                    url: 'zigbee-shepherd/unbind?id=' + id,
                    contentType: 'application/json',
                    data: JSON.stringify({
                        device: $(this).data('device'),
                        endpoint: $(this).data('endpoint'),
                        cluster: $(this).data('cluster'),
                        type: $(this).data('type') || 'endpoint',
                        targetDevice: $(this).data('target-device'),
                        targetEndpoint: $(this).data('target-endpoint')
                    }),
                    success: () => {
                        $(this).parent().parent().remove();
                    },
                    error: xhr => {
                        $(this).removeClass('disabled');
                        showError(xhr.responseText);
                    }
                });
            });

            $('#add-bind-dialog').dialog({
                autoOpen: false,
                modal: true,
                closeOnEscape: true,
                width: 480,
                buttons: [
                    {
                        text: 'Add Bind',
                        id: 'add-bind-do',
                        click() {
                            const device = $('#add-bind-device').val();
                            const endpoint = parseInt($('#add-bind-endpoint').val(), 10);
                            const cluster = $('#add-bind-cluster').val();
                            const type = $('#add-bind-type').val();
                            const targetDevice = $('#add-bind-targetDevice').val();
                            const targetEndpoint = parseInt($('#add-bind-targetEndpoint').val(), 10);
                            const group = parseInt($('#add-bind-group').val(), 10);

                            $.ajax({
                                type: 'POST',
                                url: 'zigbee-shepherd/bind?id=' + id,
                                contentType: 'application/json',
                                data: JSON.stringify({device, endpoint, cluster, type, group, targetDevice, targetEndpoint}),
                                success: () => {
                                    refreshDevices();
                                    $(this).dialog('close');
                                },
                                error: xhr => {
                                    showError(xhr.responseText);
                                }
                            });
                        }
                    }, {
                        text: 'Cancel',
                        click() {
                            $(this).dialog('close');
                        }
                    }
                ]
            });
            $('#add-bind').click(() => {
                $('#add-bind-device').val('');
                $('#add-bind-endpoint').val('');
                $('#add-bind-cluster').val('');
                $('#add-bind-type').val('endpoint');
                $('#add-bind-targetDevice').val('');
                $('#add-bind-targetEndpoint').val('');
                $('#add-bind-group').val('');
                $('#add-bind-dialog').dialog('open');
            });
            $('#add-bind-type').change(function () {
                if ($(this).val() === 'endpoint') {
                    $('.bind-to-group').hide();
                    $('.bind-to-endpoint').show();
                } else {
                    $('.bind-to-endpoint').hide();
                    $('.bind-to-group').show();
                }
            });

            function networkMap(shepherdId) {
                const container = document.querySelector('#map');
                $('#map-loader').show();

                let devices;
                const routes = [];
                const routesMap = {};

                const routesRaw = {};
                const lqiRaw = {};

                const knownDevices = [];
                let networkMap;

                $.getJSON('zigbee-shepherd/devices?id=' + shepherdId, data => {
                    devices = data;
                    devices.forEach(device => {
                        knownDevices.push(device.ieeeAddr);
                    });
                    getRtg()
                        .then(getLqi)
                        .catch(err => {
                            container.innerHTML = err.message;
                        })
                        .finally(() => {
                            $('#map-loader').hide();
                            createGraph();
                        });
                });

                function getRtg() {
                    return new Promise(resolve => {
                        const tasks = [];
                        devices.forEach(device => {
                            if (device.type === 'EndDevice') {
                                return;
                            }

                            tasks.push(() => {
                                return new Promise(resolve => {
                                    $('#map-status').html('get routing table of ' + device.ieeeAddr + ' ' + device.meta.name);

                                    $.getJSON('zigbee-shepherd/getRoutingTable?id=' + shepherdId + '&ieeeAddr=' + device.ieeeAddr, data => {
                                        routesRaw[device.ieeeAddr] = data;
                                        data.forEach(route => {
                                            const id = device.networkAddress + '|' + route.nextHop;
                                            if (route.nextHop !== 65534) {
                                                if (routesMap[id]) {
                                                    routesMap[id].count += 1;
                                                    routesMap[id].status = route.status;
                                                } else {
                                                    routesMap[id] = {
                                                        sourceIeeeAddr: device.ieeeAddr,
                                                        targetIeeeAddr: getIeeeAddr(route.nextHop),
                                                        status: route.status,
                                                        count: 1
                                                    };
                                                }
                                            }

                                            if (route.destinationAddress !== route.nextHop) {
                                                const nid = route.nextHop + '|' + route.destinationAddress;
                                                if (!routesMap[nid]) {
                                                    routesMap[nid] = {
                                                        sourceIeeeAddr: getIeeeAddr(route.nextHop),
                                                        targetIeeeAddr: getIeeeAddr(route.destinationAddress),
                                                        status: 'UNKNOWN',
                                                        count: 0
                                                    };
                                                }
                                            }
                                        });
                                    }).always(() => resolve());
                                });
                            });
                        });

                        function shiftTasks() {
                            if (stopMap) {
                                return;
                            }

                            if (tasks.length > 0) {
                                const task = tasks.shift();
                                task().then(shiftTasks);
                            } else {
                                resolve();
                            }
                        }

                        shiftTasks();
                    });
                }

                function getLqi() {
                    return new Promise(resolve => {
                        const tasks = [];
                        devices.forEach(device => {
                            if (device.type === 'EndDevice') {
                                return;
                            }

                            tasks.push(() => {
                                return new Promise(resolve => {
                                    $('#map-status').html('get lqi list of ' + device.ieeeAddr + ' ' + device.meta.name);

                                    $.getJSON('zigbee-shepherd/getLqi?id=' + shepherdId + '&ieeeAddr=' + device.ieeeAddr, data => {
                                        lqiRaw[device.ieeeAddr] = data;
                                        data.forEach(neighbour => {
                                            const id = device.networkAddress + '|' + neighbour.networkAddress;
                                            if (routesMap[id]) {
                                                if (knownDevices.includes(neighbour.ieeeAddr)) {
                                                    routesMap[id].count += 1;
                                                }

                                                routesMap[id].lqi = neighbour.linkquality;
                                                routesMap[id].depth = neighbour.depth;
                                                routesMap[id].relationship = neighbour.relationship;
                                            } else {
                                                routesMap[id] = {
                                                    sourceIeeeAddr: device.ieeeAddr,
                                                    targetIeeeAddr: neighbour.ieeeAddr,
                                                    status: '',
                                                    relationship: neighbour.relationship,
                                                    depth: neighbour.depth,
                                                    lqi: neighbour.linkquality,
                                                    count: 1
                                                };
                                            }
                                        });
                                    }).always(() => resolve());
                                });
                            });
                        });

                        function shiftTasks() {
                            if (stopMap) {
                                return;
                            }

                            if (tasks.length > 0) {
                                const task = tasks.shift();
                                task().then(shiftTasks);
                            } else {
                                Object.keys(routesMap).forEach(id => {
                                    routes.push(routesMap[id]);
                                });
                                resolve();
                            }
                        }

                        shiftTasks();
                    });
                }

                function getIeeeAddr(nwkAddr) {
                    const devs = devices.filter(device => device.networkAddress === nwkAddr);
                    if (devs.length === 1) {
                        return devs[0].ieeeAddr;
                    }
                }

                function createGraph(anonymized) {
                    //let coordAddr;
                    const routesData = routes.map(route => {
                        return {
                            to: route.targetIeeeAddr,
                            from: route.sourceIeeeAddr,
                            label: rssi(route.lqi),
                            width: (route.count + 1),
                            arrows: 'from',
                            dashes: route.status !== 'ACTIVE',
                            color: {inherit: 'to'},
                            font: {
                                color: 'rgba(0,0,0,0)'
                            },
                            chosen: {
                                label: values => {
                                    values.color = {inherit: 'to'};
                                    values.mod = 'bold';
                                }
                            }
                        };
                    });

                    const data = {
                        nodes: new vis.DataSet(devices.map(dev => {
                            const isCoord = dev.type === 'Coordinator';
                            const isBattery = dev.powerSource === 'Battery';
                            const isRouter = dev.type === 'Router';
                            const id = dev.ieeeAddr;

                            const isOffline = dev.meta.offline === true;
                            const children = routes.filter(pair => pair.sourceIeeeAddr === dev.ieeeAddr).length;
                            const label = [
                                anonymized ? '...' : dev.meta.name,
                                dev.type,
                                anonymized ? ('0x...' + dev.ieeeAddr.substr(-3)) : dev.ieeeAddr,
                                dev.manufacturerName,
                                String(dev.modelID).length > 20 ? (String(dev.modelID).substr(0, 17) + '...') : dev.modelID,
                                dev.powerSource,
                                children ? 'Children: ' + children + (isCoord ? (' (' + devices.length + ')') : '') : ''
                            ].filter(v => v).join('\n');

                            return {
                                id,
                                label,
                                shape: (isRouter || isCoord) ? 'circle' : 'box',
                                shapeProperties: {
                                    borderDashes: isOffline
                                },
                                color: {
                                    background: dev.foreign ? '#eee' : isCoord ? '#B2DC96' : (isBattery ? '#E5F2FF' : '#D2E5FF'),
                                    border: dev.foreign ? '#ccc' : isCoord ? '#028C76' : (isBattery ? '#3386E9' : '#2B7CE9'),
                                    highlight: {
                                        background: dev.foreign ? '#eee' : isCoord ? '#B2DC96' : (isBattery ? '#D2E5FF' : '#D2E5FF'),
                                        border: dev.foreign ? '#aaa' : isCoord ? '#028C76' : (isBattery ? '#2B7CE9' : '#2B7CE9')
                                    }
                                }
                                //mass: isCoord ? 1.0 : (isRouter ? 1.02 : (isOffline ? 1.035 : 1.025))

                            };
                        })),

                        edges: new vis.DataSet(routesData)
                    };

                    const options = {
                        layout: {
                            //hierarchical: true
                        },
                        physics: {
                            stabilization: true,
                            solver: 'forceAtlas2Based',
                            forceAtlas2Based: {
                                avoidOverlap: 0.00007
                            },
                            barnesHut: {
                                gravitationalConstant: -2000,
                                centralGravity: 0.37,
                                springLength: 89,
                                springConstant: 0.02,
                                damping: 0.09,
                                avoidOverlap: 0.25
                            }
                        }
                    };

                    networkMap = new vis.Network(container, data, options);

                    networkMap.on('selectNode', data => {
                        nodeInfo(data.nodes[0]);
                    });

                    networkMap.on('deselectNode', () => {
                        $('#node-info').hide();
                    });

                    if (!anonymized) {
                        $('#anonymize-map').show();
                    }

                    $('#redraw-map').show();
                }

                function nodeInfo(addr) {
                    $('#node-selected').val(addr);
                    const dev = devices.find(dev => dev.ieeeAddr === addr);

                    $('#node-addr').html(addr);
                    $('#node-name').html(dev.meta.name);

                    $('#node-device').html('');

                    [
                        'type',
                        'manufacturerName',
                        'modelID',
                        'applicationVersion',
                        'hardwareVersion',
                        'dateCode',
                        'powerSource',
                        'softwareBuildID',
                        'stackVersion',
                        'zclVersion',
                        'interviewCompleted',
                        'lastSeen',
                        'networkAddress'
                    ].forEach(key => {
                        $('#node-device').append(`<tr><td>${key}</td><td>${dev[key]}</td></tr>`);
                    });

                    [
                        'offline',
                        'reporting',
                        'shouldConfigure',
                        'shouldReport',
                        'isPingable',
                        'configureFails',
                        'reportingFails'
                    ].forEach(key => {
                        $('#node-device').append(`<tr><td>${key}</td><td>${dev.meta[key]}</td></tr>`);
                    });

                    let lqiHtml = '<tr><th>ieeeAddr</th><th>name</th><th>LQI</th><th>depth</th><th>relationship</th></tr>';

                    if (lqiRaw[addr]) {
                        lqiRaw[addr].forEach(entry => {
                            const entryDev = devices.find(d => d.ieeeAddr === entry.ieeeAddr);
                            const name = (entryDev && entryDev.meta.name) || '';
                            lqiHtml += `<tr><td class="dev-link" data-addr="${entry.ieeeAddr}">${entry.ieeeAddr}</td><td>${name}</td><td>${rssi(entry.linkquality)}</td><td>${entry.depth}</td><td>${entry.relationship}</td></tr>`;
                        });
                    }

                    $('#node-lqi').html(lqiHtml);

                    let routesHtml = '<tr><th colspan="2">destination</th><th colspan="2">nexthop</th><th></th></tr>';
                    routesHtml += '<tr><th>ieeeAddr</th><th>name</th><th>ieeeAddr</th><th>name</th><th>status</th></tr>';

                    if (routesRaw[addr]) {
                        routesRaw[addr].forEach(route => {
                            const destDev = devices.find(d => d.networkAddress === route.destinationAddress) || {meta: {name: ''}};
                            const hopDev = devices.find(d => d.networkAddress === route.nextHop) || {meta: {name: ''}};
                            routesHtml += `<tr><td class="dev-link" data-addr="${destDev.ieeeAddr}">${destDev.ieeeAddr}</td><td>${destDev.meta.name}</td><td class="dev-link" data-addr="${hopDev.ieeeAddr}">${hopDev.ieeeAddr}</td><td>${hopDev.meta.name}</td><td>${route.status}</td></tr>`;
                        });
                    }

                    $('#node-routes').html(routesHtml);

                    $('.dev-link').click(function () {
                        nodeInfo($(this).data('addr'));
                        networkMap.selectNodes([$(this).data('addr')]);
                    });

                    $('.dev-link').hover(
                        function () {
                            $(this).addClass('dev-link-hover');
                        },
                        function () {
                            $(this).removeClass('dev-link-hover');
                        }
                    );

                    $('#node-info').show();
                }

                $('#node-info-close').click(() => {
                    $('#node-info').hide();
                });

                $('#anonymize-map').click(() => {
                    networkMap.destroy();
                    createGraph(true);
                });

                $('#redraw-map').click(() => {
                    networkMap.destroy();
                    createGraph();
                });

                /*
                    lqi => rssi
                    https://e2e.ti.com/support/wireless-connectivity/zigbee-and-thread/f/158/t/555076?How-to-get-rssi-value-from-Z-Stack-Linux-Gateway-
                    RSSI = MIN_ED+LinkQuality*( MAX_ED-MIN_ED)/255
                    Default values for MIN_ED and MAX_ED are -87 and 10 respectively.
                 */
                function rssi(lqi) {
                    const rssi = Math.round(-87 + (lqi * 97 / 255));
                    return lqi ? `${rssi} dBm\n(${lqi})` : '';
                }
            }
        },
        oneditsave() {
            console.log('oneditsave creds', this.credentials);

            clearInterval(this.statusInterval);
            clearInterval(this.refreshInterval);
            $.getJSON('zigbee-shepherd/join?id=' + this.id + '&permit=false');

            const arr = [];
            for (let i = 11; i <= 26; i++) {
                if ($('#channel-' + i).is(':checked')) {
                    arr.push(i);
                }
            }

            console.log(this.credentials);

            this.channelList = arr;
            this.rtscts = $('#rtscts').val() === 'true';

            const {devices, groups, id} = this;
            $('ol#devices .device-name').each(function () {
                const ieeeAddr = $(this).data('addr');
                const name = $(this).val();
                const device = devices.find(dev => dev.ieeeAddr === ieeeAddr);
                if (device.meta.name !== name) {
                    $.ajax({
                        type: 'POST',
                        url: 'zigbee-shepherd/rename?id=' + id,
                        contentType: 'application/json',
                        data: JSON.stringify({ieeeAddr, name})
                    });
                }
            });
            $('ol#groups .group-name').each(function () {
                const groupID = parseInt($(this).data('groupid'), 10);
                const name = $(this).val();
                const group = groups.find(group => group.groupID === groupID);
                if (group.meta.name !== name) {
                    $.ajax({
                        type: 'POST',
                        url: 'zigbee-shepherd/rename?id=' + id,
                        contentType: 'application/json',
                        data: JSON.stringify({groupID, name})
                    });
                }
            });
            $('ol#reporting li .device-report').each(function () {
                const ieeeAddr = $(this).data('addr');
                const shouldReport = $(this).is(':checked');
                const device = devices.find(dev => dev.ieeeAddr === ieeeAddr);
                if (Boolean(device.meta.shouldReport) !== shouldReport) {
                    $.ajax({
                        type: 'POST',
                        url: 'zigbee-shepherd/report?id=' + id,
                        contentType: 'application/json',
                        data: JSON.stringify({ieeeAddr, shouldReport})
                    });
                }
            });
            $('ol#reporting li .device-ping').each(function () {
                const ieeeAddr = $(this).data('addr');
                const shouldPing = $(this).is(':checked');
                const device = devices.find(dev => dev.ieeeAddr === ieeeAddr);
                if (Boolean(device.meta.shouldPing) !== shouldPing) {
                    $.ajax({
                        type: 'POST',
                        url: 'zigbee-shepherd/ping?id=' + id,
                        contentType: 'application/json',
                        data: JSON.stringify({ieeeAddr, shouldPing})
                    });
                }
            });
            $('ol#reporting li .device-configure').each(function () {
                const ieeeAddr = $(this).data('addr');
                const shouldConfigure = $(this).is(':checked');
                const device = devices.find(dev => dev.ieeeAddr === ieeeAddr);
                if (Boolean(device.meta.shouldConfigure) !== shouldConfigure) {
                    $.ajax({
                        type: 'POST',
                        url: 'zigbee-shepherd/configure?id=' + id,
                        contentType: 'application/json',
                        data: JSON.stringify({ieeeAddr, shouldConfigure})
                    });
                }
            });
        },
        oneditcancel() {
            clearInterval(this.statusInterval);
            clearInterval(this.refreshInterval);
            $.getJSON('zigbee-shepherd/join?id=' + this.id + '&permit=false');
        }

    });
</script>

<script type="text/x-red" data-template-name="zigbee-shepherd">

    <style>
        #channels {
            width: calc(70% - 100px);
            display: inline-block;
            margin: 0;
        }
        #channels label {
            display: inline;
            margin-right: 8px;
            white-space: nowrap;
        }
        #channels label input {
            width: auto;
            margin-top: -2px;
        }
        #channels-label {
            vertical-align: text-bottom;

        }

        ul#node-config-zigbee-shepherd-tabs li.red-ui-tab {
            max-width: 120px;
        }
        .device-select {
            width: 360px;
        }
        .group-row {
            padding: 5px;
            width: calc(100% - 10px);
            height: 100%;
        }
        .group-row.selected {
            background-color: #eee;
        }
        .member-endpoint, .member-name {
            display: inline-block;
            vertical-align: top;
        }
        .member-endpoint {
            width: 40px;
            text-align: right;
            padding-right: 24px;
        }
        .group-id {
            display: inline-block;
            width: 60px;
            text-align: right;
            padding-right: 12px;
        }
        .checkbox-reporting, .checkbox-configure, .checkbox-ping {
            vertical-align: top;
            display: inline-block;
            width: 44px;
            margin-right: 8px;
            text-align: center;
        }
        .checkbox-reporting input, .checkbox-configure input, .checkbox-ping input {
            width: auto;

        }
        ol#reporting .member-name {
            vertical-align: 8px;
        }
        .bind-endpoint, .bind-targetEndpoint {
            display: inline-block;
            text-align: right;
            width: 40px;

        }
        .bind-cluster {
            display: inline-block;
            width: 130px;
            margin-left: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: bottom;
        }
        #device-details {
            width: 420px;
            height: 480px;
            font-size: 12px;
            font-family: monospace;
            white-space: pre;
            overflow: scroll;
        }


    </style>

    <div class="form-row">
        Status: <span id="status"></span>
    </div>

    <div class="form-row">
        <ul style="background: #fff; min-width: 480px; margin-bottom: 20px;" id="node-config-zigbee-shepherd-tabs"></ul>
    </div>

    <div id="node-config-zigbee-shepherd-tabs-content" style="min-height: 170px;">
        <div id="zigbee-shepherd-tab-config" style="display:none">

            <div class="form-row">
                <label for="node-config-input-name"><i class="icon-bookmark"></i> name</label>
                <input type="text" id="node-config-input-name">
            </div>
            <div class="form-row"><h4>serialport</h4></div>
            <div class="form-row">
                <label for="node-config-input-adapter"><i class="icon-bookmark"></i> adapter</label>
                <select id="node-config-input-adapter">
                    <option value="zstack">Z-Stack</option>
                    <option value="deconz">ConBee</option>
                    <option value="zigate">ZiGate</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-config-input-path"><i class="icon-bookmark"></i> path</label>
                <input type="text" id="node-config-input-path">
            </div>
            <div class="form-row">
                <label for="node-config-input-baudRate"><i class="icon-bookmark"></i> baudRate</label>
                <input type="text" id="node-config-input-baudRate">
            </div>
            <div class="form-row">
                <label for="rtscts"><i class="icon-bookmark"></i> rtscts</label>
                <select id="rtscts">
                    <option value="true">true</option>
                    <option value="false">false</option>
                </select>
            </div>


            <div class="form-row"><h4>zigbee</h4></div>

            <div class="form-row">
                <label id="channels-label" for="channels"><i class="icon-bookmark"></i> channels<br><br><br></label>
                <div id="channels">

                    <label><input type="checkbox" id="channel-11"> 11</label>
                    <label><input type="checkbox" id="channel-12"> 12</label>
                    <label><input type="checkbox" id="channel-13"> 13</label>
                    <label><input type="checkbox" id="channel-14"> 14</label>
                    <label><input type="checkbox" id="channel-15"> 15</label><br>
                    <label><input type="checkbox" id="channel-16"> 16</label>
                    <label><input type="checkbox" id="channel-17"> 17</label>
                    <label><input type="checkbox" id="channel-18"> 18</label>
                    <label><input type="checkbox" id="channel-19"> 19</label>
                    <label><input type="checkbox" id="channel-20"> 20</label><br>
                    <label><input type="checkbox" id="channel-21"> 21</label>
                    <label><input type="checkbox" id="channel-22"> 22</label>
                    <label><input type="checkbox" id="channel-23"> 23</label>
                    <label><input type="checkbox" id="channel-24"> 24</label>
                    <label><input type="checkbox" id="channel-25"> 25</label><br>
                    <label><input type="checkbox" id="channel-26"> 26</label>

                </div>
            </div>

            <div class="form-row">
                <label for="node-config-input-panId"><i class="icon-bookmark"></i> panId</label>
                <input type="text" id="node-config-input-panId">
            </div>

            <div class="form-row">
                <label for="node-config-input-extPanId"><i class="icon-bookmark"></i> extPanId</label>
                <input type="text" id="node-config-input-extPanId">
            </div>

            <div class="form-row">
                <label for="node-config-input-precfgkey"><i class="icon-bookmark"></i> networkKey</label>
                <input type="text" id="node-config-input-precfgkey">
            </div>
            <div class="form-row">
                <label for="node-config-input-led"><i class="icon-bookmark"></i> CC2531 LED</label>
                <select id="node-config-input-led">
                    <option value="disabled">disabled</option>
                    <option value="enabled">enabled</option>
                </select>
            </div>
            <div class="form-row">
                Changing the configuration of an already existing Herdsman needs a Node-RED restart after deployment.
            </div>
        </div>


        <div id="zigbee-shepherd-tab-devices" style="display:none">
            <style>
                #network-map {
                    display: none;
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    top: 0;
                    left: 0;
                    background-color: white;
                    z-index: 100000;
                }

                #network-map h4 {
                    margin: 6px;
                }
                #network-map #map {
                    height: calc(100% - 30px);
                }
                #network-map #map-loader {
                    position: absolute;
                    top: 50px;
                    left: calc(50% - 64px);
                }
                .device-address, .device-type, .device-model {
                    display: inline-block !important;
                    overflow: hidden;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    font-size: 10px;
                    line-height: 12px;
                    padding: 2px;
                }
                .device-address {
                    width: 110px;
                }
                .bind-address, .bind-targetIeeeAddr {
                    width: 150px;
                    display: inline-block;
                }
                .bind-title {
                    width: 54px;
                    display: inline-block;

                }
                .device-model {
                    width: 110px;
                }
                input.device-name {
                    width: calc(100% - 285px) !important;
                    display: inline-block !important;
                }
                input.device-remove {
                    margin-left: 4px;
                    width: 20px !important;
                    display: inline-block !important;
                    font-size: 10px;
                }
                #join-permit, #join-stop {
                    width: 80px;
                    display: inline-block;
                }
                .incomplete {
                    color: #777;
                }
                #add-bind-dialog select {
                    width: 70%;
                }
                ol#groups li {
                    padding: 0;
                }
                .device-details {
                    position: absolute;
                    top: 17px;
                    right: 23px;
                }
                #device-details {
                    font-family: monospace;
                    white-space: pre;
                }
            </style>
            <div class="form-row">
                <button id="join-permit">PermitJoin</button>
                <button id="join-stop">StopJoin</button>
                <button id="touchlink-reset">TouchlinkFactoryReset</button>
                <button id="show-network-map">NetworkMap</button>

            </div>

            <div class="form-row"><h4>devices</h4></div>

            <div class="form-row">
                <ol id="devices"></ol>
            </div>

        </div>

        <div id="zigbee-shepherd-tab-reporting" style="display:none">
            <div class="form-row">
                <ol id="reporting"></ol>
            </div>
        </div>

        <div id="zigbee-shepherd-tab-groups" style="display:none">
            <div class="form-row">
                Groups
            </div>
            <div class="form-row">
                <ol id="groups"></ol>
                <a href="#" id="add-group" class="editor-button editor-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> add group</a>
            </div>
            <div id="add-group-dialog" title="Add Group" dialog>
                <div class="form-row">
                    <label for="add-group-id">ID</label>
                    <input id="add-group-id" type="number">
                </div>
                <div class="form-row">
                    <label for="add-group-name">Name</label>
                    <input id="add-group-name" type="text">
                </div>

            </div>
            <div class="form-row">
               <span id="selected-group"></span>
               <input type="hidden" id="selected-group-id">
            </div>
            <div class="form-row">
                <ol id="members"></ol>
                <a href="#" id="add-member" class="disabled editor-button editor-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> add member</a>
            </div>
            <div id="add-member-dialog" title="Add Member" dialog>
                <label for="add-member-select">Device</label>
                <select id="add-member-select" class="device-select"></select>
                <label for="add-member-endpoint-select">Endpoint</label>
                <select id="add-member-endpoint-select" class=""></select>
            </div>
        </div>


        <div id="zigbee-shepherd-tab-binds" style="display:none">
            <div class="form-row">
                <label style="width: 240px;">Show Coordinator Binds <input type="checkbox" id="show-coord-binds" style="width: 30px; vertical-align: top;"></label>
                <ol id="binds"></ol>
                <a href="#" id="add-bind" class="editor-button editor-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> add bind</a>
            </div>
            <div id="add-bind-dialog" title="Add Bind" dialog>
                <div class="form-row">
                    <label for="add-bind-device">Device</label>
                    <select id="add-bind-device"></select>
                </div>
                <div class="form-row">
                    <label for="add-bind-endpoint">Endpoint</label>
                    <select id="add-bind-endpoint"></select>
                </div>
                <div class="form-row">
                    <label for="add-bind-cluster">Cluster</label>
                    <select id="add-bind-cluster"></select>
                </div>
                <div class="form-row">
                    <label for="add-bind-type">Target</label>
                    <select id="add-bind-type">
                        <option value="endpoint">Endpoint</option>
                        <option value="group">Group</option>
                    </select>
                </div>
                <div class="bind-to-endpoint">
                    <div class="form-row">
                        <label for="add-bind-targetDevice">Target Device</label>
                        <select id="add-bind-targetDevice"></select>
                    </div>
                    <div class="form-row">
                        <label for="add-bind-targetEndpoint">Target Endpoint</label>
                        <select id="add-bind-targetEndpoint"></select>
                    </div>
                </div>
                <div class="form-row bind-to-group" style="display: none;">
                    <label for="add-bind-group">Target Group</label>
                    <select id="add-bind-group"></select>
                </div>
            </div>
        </div>

         <div id="device-details-dialog" title="Error" dialog>
            <div id="device-details"></textarea>
        </div>


        <div id="error-dialog" title="Error" dialog>
            <div id="error-message"></div>
        </div>

        <style>
            #network-map {
                font-family: monospace;
            }
            #map-container {
                flex-grow: 1;
                height: 100%;
            }
            #map {
                height: 100%;
            }
            #node-routes, #node-lqi, #node-device {
                font-size: 11px;
                border-collapse: collapse
            }
            .dev-link-hover {
                background-color: lightgrey;
            }
        </style>

        <div id="network-map">

            <div id="map-loader"><img src="zigbee-shepherd/map/loader.gif" id="map-loader-progress"><br><span id="map-status"></span></div>

            <div style="display: flex; height: 100%;">
                <div id="map-container">
                    <h4>ZigBee Network Map <button id="hide-network-map">Close</button> <button style="display:none" id="redraw-map">Redraw</button> <button style="display:none" id="anonymize-map">Anonymize</button></h4>
                    <div id="map"></div>
                </div>
                <div id="node-info" style="flex-shrink: 0; display: none; height: 100%; width: 586px; border-left: 3px solid grey; padding: 3px;">
                    <input type="hidden" id="node-selected">
                    <h4><span id="node-name"></span> (<span id="node-addr"></span>) <button id="node-info-close">close</button></h4>
                    <table id="node-device" border="1"></table>
                    <h4>Routes</h4>
                    <!--<button id="refresh-routes">Refresh</button>-->
                    <table id="node-routes" border="1"></table>
                    <h4>LQI</h4>
                    <!--<button id="refresh-lqi">Refresh</button>-->
                    <table id="node-lqi" border="1"></table>
                </div>
            </div>
            <script type="text/javascript" src="zigbee-shepherd/vis/vis.min.js"></script>
            <link href="zigbee-shepherd/vis/vis.min.css" type="text/css"/>
        </div>

    </div>

</script>
